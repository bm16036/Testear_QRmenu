<section class="feature">
  <header class="feature__header">
    <div>
      <h1>Productos y platillos</h1>
      <p>Organiza tu oferta por categoría y mantén tu menú actualizado.</p>
    </div>
    <button type="button" class="feature__reset" *ngIf="selectedProductId()" (click)="cancelEdit()">
      Cancelar edición
    </button>
  </header>

  <div class="feature__grid">
    <section class="panel">
      <h2>{{ selectedProductId() ? 'Editar producto' : 'Nuevo producto' }}</h2>

      <form [formGroup]="productForm" (ngSubmit)="save()" class="form">
        <label class="form__field">
          <span>Nombre</span>
          <input type="text" formControlName="name" placeholder="Ej. Ceviche clásico" />
          <small class="form__error" *ngIf="productForm.get('name')?.invalid && productForm.get('name')?.touched">
            Ingresa un nombre válido (máximo 120 caracteres).
          </small>
        </label>

        <label class="form__field">
          <span>Descripción</span>
          <textarea formControlName="description" placeholder="Describe brevemente el platillo."></textarea>
          <small class="form__error" *ngIf="productForm.get('description')?.invalid && productForm.get('description')?.touched">
            Describe el producto para tus clientes (máximo 800 caracteres).
          </small>
        </label>

        <label class="form__field">
          <span>Precio ($)</span>
          <input type="number" formControlName="price" min="0.01" step="0.01" />
          <small class="form__hint">Previsualización: $ {{ formattedPricePreview() }}</small>
          <small class="form__error" *ngIf="productForm.get('price')?.invalid && productForm.get('price')?.touched">
            Ingresa un precio mayor a cero.
          </small>
        </label>

        <label class="form__field">
          <span>Imagen</span>
          <input type="url" formControlName="imageUrl" placeholder="https://" />
          <small class="form__hint">Utiliza una URL accesible públicamente.</small>
          <small class="form__error" *ngIf="productForm.get('imageUrl')?.invalid && productForm.get('imageUrl')?.touched">
            Ingresa una URL válida para la imagen.
          </small>
        </label>

        <label class="form__field form__field--checkbox">
          <span>Estado</span>
          <div class="toggle">
            <input type="checkbox" formControlName="active" />
            <span>{{ productForm.get('active')?.value ? 'Activo' : 'Inactivo' }}</span>
          </div>
          <small class="form__hint">Define si el producto estará disponible en los menús seleccionados.</small>
        </label>

        <label class="form__field">
          <span>Categoría</span>
          <select formControlName="categoryId">
            <option value="" disabled>Selecciona una categoría</option>
            <option
              *ngFor="let category of categories()"
              [value]="category.id"
              [disabled]="!category.active"
            >
              {{ category.name }}{{ category.active ? '' : ' (Inactiva)' }}
            </option>
          </select>
          <small
            class="form__error"
            *ngIf="categoryIdControl.hasError('required') && categoryIdControl.touched"
          >
            Selecciona la categoría a la que pertenece el producto.
          </small>
          <p class="form__warning" *ngIf="inactiveCategoryNotice()">{{ inactiveCategoryNotice() }}</p>
        </label>

        <fieldset class="form__field form__field--checkbox-group">
          <legend>Menús</legend>
          <div class="checkbox-group" *ngIf="menus().length; else noMenusAvailable">
            <label
              class="checkbox-option"
              *ngFor="let menu of menus()"
              [class.checkbox-option--inactive]="!menu.active"
              [title]="menu.name"
            >
              <input
                type="checkbox"
                [value]="menu.id"
                [checked]="isMenuSelected(menu.id)"
                [disabled]="!menu.active"
                (change)="toggleMenuSelection(menu.id, $event.target.checked)"
              />
              <span class="checkbox-option__name">{{ menu.name }}</span>
              <span class="checkbox-option__status" *ngIf="!menu.active">(Inactivo)</span>
            </label>
          </div>
          <ng-template #noMenusAvailable>
            <p class="checkbox-group__empty">Aún no hay menús disponibles.</p>
          </ng-template>
          <small class="form__hint">Selecciona uno o varios menús donde se mostrará el producto.</small>
          <small class="form__error" *ngIf="productForm.get('menuIds')?.invalid && productForm.get('menuIds')?.touched">
            El producto debe pertenecer al menos a un menú activo.
          </small>
        </fieldset>

        <button type="submit" class="form__submit" [disabled]="isSaving()">
          {{ isSaving() ? 'Guardando...' : 'Guardar producto' }}
        </button>

        <p class="form__feedback" *ngIf="feedbackMessage()">{{ feedbackMessage() }}</p>
      </form>
    </section>

    <section class="panel">
      <h2>Listado de productos</h2>

      <table class="table" *ngIf="products().length; else emptyState">
        <thead>
          <tr>
            <th>Platillo</th>
            <th>Precio</th>
            <th>Categoría y menús</th>
            <th class="table__actions">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let product of products()">
            <td>
              <div class="product-info">
                <img [src]="product.imageUrl" [alt]="product.name" />
                <div>
                  <p>{{ product.name }}</p>
                  <small>{{ product.description }}</small>
                </div>
              </div>
            </td>
            <td>$ {{ product.price | number: '1.2-2' }}</td>
            <td>
              <div class="table__category">{{ getCategoryName(product.categoryId) }}</div>
              <ul class="product-menus" *ngIf="product.menuIds.length; else noMenus">
                <li *ngFor="let menu of getMenuNames(product.menuIds)">{{ menu }}</li>
              </ul>
              <ng-template #noMenus>
                <span class="product-menus product-menus--empty">Sin menús asignados</span>
              </ng-template>
            </td>
            <td class="table__actions">
              <button type="button" (click)="edit(product)">Editar</button>
              <button type="button" class="danger" (click)="delete(product.id)">Eliminar</button>
            </td>
          </tr>
        </tbody>
      </table>

      <ng-template #emptyState>
        <p class="panel__empty">Registra tus productos para comenzar a mostrarlos.</p>
      </ng-template>
    </section>
  </div>
</section>
